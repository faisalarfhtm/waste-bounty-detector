<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Daftar Bounty Sampah · Smart Waste Detector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='Web/style.css') }}"
    />
  </head>
  <body>
    <header class="navbar light">
      <div class="navbar-left">
        <div class="logo-circle-light">SW</div>
        <div class="logo-text">
          <span class="logo-title">Smart Waste Detector</span>
          <span class="logo-subtitle">Daftar Bounty Sampah</span>
        </div>
      </div>
      <nav class="navbar-right">
        <a href="{{ url_for('index') }}">Beranda</a>
        <a href="{{ url_for('logout') }}" class="btn-nav-secondary">Logout</a>
      </nav>
    </header>

    <main class="main light">
      <section class="section">
        <h2 style="margin-top: 0; margin-bottom: 10px">
          Bounty di Sekitar Kamu
        </h2>
        <p class="hero-subtitle">
          Klik "Gunakan lokasi saya" untuk melihat bounty dalam radius 100 meter
          dari posisi kamu.
        </p>

        <button
          type="button"
          class="btn-primary"
          onclick="useLocationForBounty()"
        >
          Gunakan lokasi saya
        </button>

        {% if user_lat and user_lon %}
        <p class="hint-text">
          Menampilkan bounty OPEN dalam radius 100 m dari ({{
          "%.5f"|format(user_lat) }}, {{ "%.5f"|format(user_lon) }}).
        </p>
        {% else %}
        <p class="hint-text">
          Lokasi belum aktif. Tidak ada bounty OPEN yang ditampilkan sampai
          lokasi tersedia.
        </p>
        {% endif %} {% with messages =
        get_flashed_messages(with_categories=true) %} {% if messages %}
        <ul class="flash-list">
          {% for category, message in messages %}
          <li class="flash flash-{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
        {% endif %} {% endwith %} {% if open_bounties %}
        <div class="reward-grid">
          {% for b in open_bounties %}
          <div class="card result-card-light">
            <h3 style="margin-top: 0">Bounty #{{ b.id }}</h3>
            <p class="result-subtitle">
              Pelapor: <strong>{{ b.reporter_name }}</strong><br />
              Lokasi (teks): {{ b.location or '-' }}<br />
              {% if b.distance_m is not none %} Perkiraan jarak: {{
              "%.1f"|format(b.distance_m) }} m<br />
              {% endif %} Poin cleaner:
              <strong class="accent-green">{{ b.points_cleaner }}</strong>
            </p>
            <img
              src="{{ url_for('static', filename='upload/' + b.before_image) }}"
              alt="Before"
              class="result-image"
            />
            <form
              action="{{ url_for('bounty_claim', bounty_id=b.id) }}{% if user_lat and user_lon %}?lat={{ user_lat }}&lon={{ user_lon }}{% endif %}"
              method="post"
              style="margin-top: 10px"
            >
              <button type="submit" class="btn-primary">
                Ambil Bounty Ini
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="hint-text">
          Tidak ada bounty OPEN dalam radius 100 m dari lokasimu (atau lokasi
          belum aktif).
        </p>
        {% endif %}
      </section>

      <section class="section">
        <h2 style="margin-top: 0; margin-bottom: 10px">
          Bounty yang Sedang Kamu Kerjakan
        </h2>
        <p class="hero-subtitle">
          Ini adalah bounty yang sudah kamu ambil (status CLAIMED) dan belum
          selesai. Kamu bisa melanjutkan upload foto AFTER yang bersih dari
          sini.
        </p>

        {% if my_claimed %}
        <div class="reward-grid">
          {% for b in my_claimed %}
          <div class="card result-card-light">
            <h3 style="margin-top: 0">Bounty #{{ b.id }}</h3>
            <p class="result-subtitle">
              Pelapor: <strong>{{ b.reporter_name }}</strong><br />
              Lokasi (teks): {{ b.location or '-' }}<br />
              Poin cleaner:
              <strong class="accent-green">{{ b.points_cleaner }}</strong><br />
              Diambil pada: {{ b.claimed_at or '-' }}
            </p>
            <img
              src="{{ url_for('static', filename='upload/' + b.before_image) }}"
              alt="Before"
              class="result-image"
            />
            <a
              href="{{ url_for('bounty_complete', bounty_id=b.id) }}"
              class="btn-primary"
              style="
                display: inline-block;
                text-align: center;
                margin-top: 10px;
                text-decoration: none;
              "
            >
              Lanjutkan & Upload AFTER
            </a>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="hint-text">
          Kamu belum punya bounty yang sedang dikerjakan, atau semua sudah
          selesai ✅.
        </p>
        {% endif %}
      </section>
    </main>

    <script>
      function useLocationForBounty() {
        if (!navigator.geolocation) {
          alert("Browser tidak mendukung geolocation.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const url = new URL(window.location.href);
            url.searchParams.set("lat", lat);
            url.searchParams.set("lon", lon);
            window.location.href = url.toString();
          },
          function (err) {
            alert("Gagal mengambil lokasi: " + err.message);
          }
        );
      }
    </script>

    <footer class="footer-light">
      <span>Smart Waste Detector · Bounty List</span>
    </footer>
  </body>
</html>
